<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Knowledge Base ‚Äî HR Assistant</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-icon">üìã</div>
            <div class="header-text">
                <h1>HR Policy Assistant</h1>
                <p>Ask questions about company policies, benefits, and procedures</p>
            </div>
            <div class="status-badge" id="statusBadge">Loading...</div>
        </header>

        <!-- Chat Area -->
        <main class="chat-area" id="chatArea">
            <div class="welcome-message">
                <div class="welcome-icon">üëã</div>
                <h2>Welcome to the HR Knowledge Base</h2>
                <p>I can help you find information about company policies, leave rules, benefits, and more.</p>
                <div class="suggestion-chips">
                    <button class="chip" onclick="askQuestion('What is the remote work policy?')">Remote Work Policy</button>
                    <button class="chip" onclick="askQuestion('How many annual leaves do I get?')">Annual Leave</button>
                    <button class="chip" onclick="askQuestion('What health insurance coverage is provided?')">Health Insurance</button>
                    <button class="chip" onclick="askQuestion('What is the notice period?')">Notice Period</button>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="input-area">
            <form id="queryForm" onsubmit="handleSubmit(event)">
                <div class="input-wrapper">
                    <input type="text" id="queryInput" placeholder="Ask about HR policies..." autocomplete="off">
                    <button type="submit" id="sendBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </footer>
    </div>

    <script>
        // Check status on load
        fetch('/status')
            .then(r => r.json())
            .then(data => {
                const badge = document.getElementById('statusBadge');
                badge.textContent = `${data.chunk_count} chunks indexed`;
                badge.classList.add('active');
            });

        function askQuestion(question) {
            document.getElementById('queryInput').value = question;
            handleSubmit(new Event('submit'));
        }

        function handleSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('queryInput');
            const query = input.value.trim();
            if (!query) return;

            // Remove welcome message
            const welcome = document.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            // Add user message
            addMessage(query, 'user');
            input.value = '';

            // Show loading
            const loadingId = addLoading();

            // Send query
            fetch('/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            })
            .then(r => r.json())
            .then(data => {
                removeLoading(loadingId);
                addMessage(data.answer, 'assistant', data.sources);
            })
            .catch(err => {
                removeLoading(loadingId);
                addMessage('Error: Could not get a response. Please try again.', 'assistant');
            });
        }

        function addMessage(text, role, sources = []) {
            const chatArea = document.getElementById('chatArea');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;

            let html = `
                <div class="message-avatar">${role === 'user' ? 'üë§' : 'üìã'}</div>
                <div class="message-content">
                    <div class="message-text">${formatText(text)}</div>
            `;

            if (sources && sources.length > 0) {
                html += `
                    <div class="sources-section">
                        <button class="sources-toggle" onclick="toggleSources(this)">
                            üìÑ View Sources (${sources.length})
                        </button>
                        <div class="sources-list" style="display:none;">
                `;
                sources.forEach(s => {
                    html += `
                        <div class="source-card">
                            <div class="source-header">
                                <span class="source-file">üìÅ ${s.source}</span>
                                <span class="source-score">${(s.score * 100).toFixed(1)}% match</span>
                            </div>
                            <div class="source-text">${s.text.substring(0, 200)}${s.text.length > 200 ? '...' : ''}</div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            html += '</div>';
            msgDiv.innerHTML = html;
            chatArea.appendChild(msgDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function formatText(text) {
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function addLoading() {
            const chatArea = document.getElementById('chatArea');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = id;
            div.innerHTML = `
                <div class="message-avatar">üìã</div>
                <div class="message-content">
                    <div class="loading-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function toggleSources(btn) {
            const list = btn.nextElementSibling;
            list.style.display = list.style.display === 'none' ? 'block' : 'none';
            btn.textContent = list.style.display === 'none'
                ? `üìÑ View Sources (${list.children.length})`
                : `üìÑ Hide Sources`;
        }
    </script>
</body>
</html>
